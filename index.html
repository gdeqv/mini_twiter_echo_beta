<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Echo</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { background:#121212; color:#fff; font-family:sans-serif; margin:0; padding:0; }
header { padding:15px; background:#1a1a1a; text-align:center; font-size:1.5em; font-weight:bold; }
#auth-buttons { padding:10px; display:flex; gap:10px; justify-content:center; background:#1a1a1a; }
#nickname-modal {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.8); justify-content:center; align-items:center;
}
#nickname-modal > div { background:#222; padding:20px; border-radius:10px; text-align:center; }
.new-post { margin:10px; display:flex; gap:5px; justify-content:center; }
.new-post input { flex:1; padding:5px; }
.new-post button { padding:5px 10px; }
.post { background:#1e1e1e; margin:10px auto; padding:10px; border-radius:8px; width:90%; max-width:600px; }
.post button { margin-right:5px; }
</style>
</head>
<body>

<header>Echo</header>

<div id="auth-buttons">
    <button onclick="signIn()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <button onclick="signOut()">–í—ã–π—Ç–∏</button>
    <button onclick="changeNickname()">–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
</div>

<div id="nickname-modal">
    <div>
        <h3>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫ (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞ –∏ —Ü–∏—Ñ—Ä—ã)</h3>
        <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω–∏–∫" style="padding:5px; margin-top:10px;"/>
        <button onclick="saveNickname()" style="margin-top:10px; padding:5px 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div class="new-post">
    <input type="text" id="new-post-input" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?"/>
    <button onclick="addPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</div>

<div id="posts-tab"></div>

<script>
// --- Firebase config ---
const firebaseConfig = {
    apiKey: "AIzaSyDYNBFXBRNg68Z3u_T4JTa-kRqorWKtZek",
    authDomain: "echo-beta-edb51.firebaseapp.com",
    projectId: "echo-beta-edb51",
    storageBucket: "echo-beta-edb51.firebasestorage.app",
    messagingSenderId: "18552431523",
    appId: "1:18552431523:web:7541c2d8f549dcb55cf016",
    measurementId: "G-XQ49S7VDS1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let currentUser = null;

// --- Auth state ---
firebase.auth().onAuthStateChanged(user => {
    currentUser = user;
    if(user && !user.displayName){
        document.getElementById('nickname-modal').style.display='flex';
    }
    renderPosts();
});

// --- Sign in via Google ---
function signIn(){
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithRedirect(provider);
}

// --- Handle redirect result ---
firebase.auth().getRedirectResult().then(result => {
    if(result.user){
        currentUser = result.user;
        if(!currentUser.displayName){
            document.getElementById('nickname-modal').style.display='flex';
        }
        renderPosts();
    }
}).catch(err => console.log(err));

// --- Sign out ---
function signOut(){
    firebase.auth().signOut().then(()=>{ currentUser=null; renderPosts(); });
}

// --- Change nickname manually ---
function changeNickname(){
    if(!currentUser) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!');
    document.getElementById('nickname-modal').style.display='flex';
}

// --- Save nickname ---
function saveNickname(){
    const nick = document.getElementById('nickname-input').value.trim();
    if(!nick) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!');
    if(!/^[a-zA-Z0-9]+$/.test(nick)) return alert('–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞ –∏ —Ü–∏—Ñ—Ä—ã!');
    currentUser.updateProfile({displayName:nick}).then(()=>{
        document.getElementById('nickname-modal').style.display='none';
        renderPosts();
    });
}

// --- Add post ---
function addPost(){
    if(!currentUser) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!');
    const text = document.getElementById('new-post-input').value.trim();
    if(!text) return;
    const postData = {
        author: '@'+currentUser.displayName,
        text,
        likes:0,
        reposts:0,
        comments:[],
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    db.collection('posts').add(postData).then(()=>{
        document.getElementById('new-post-input').value='';
        renderPosts();
    });
}

// --- Render posts ---
function renderPosts(){
    const container = document.getElementById('posts-tab');
    container.innerHTML='';
    db.collection('posts').orderBy('timestamp','desc').get().then(snapshot=>{
        snapshot.forEach(doc=>{
            const post = {id:doc.id, ...doc.data()};
            const div = document.createElement('div');
            div.className='post';
            div.innerHTML=`
                <h4>${post.author}</h4>
                <p>${post.text}</p>
                <button onclick="likePost('${post.id}')">‚ù§ ${post.likes}</button>
                <button onclick="showComments('${post.id}')">üí¨ ${post.comments.length}</button>
                <button onclick="repostPost('${post.id}')">üîÅ ${post.reposts}</button>
                <div id="comments-${post.id}"></div>
            `;
            container.appendChild(div);
        });
    });
}

// --- Like, repost, comment ---
function likePost(id){
    if(!currentUser){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!'); return; }
    const postRef = db.collection('posts').doc(id);
    postRef.update({likes: firebase.firestore.FieldValue.increment(1)}).then(renderPosts);
}

function repostPost(id){
    if(!currentUser){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!'); return; }
    const postRef = db.collection('posts').doc(id);
    postRef.update({reposts: firebase.firestore.FieldValue.increment(1)}).then(renderPosts);
}

function showComments(id){
    const div = document.getElementById(`comments-${id}`);
    if(div.style.display==='block'){ div.style.display='none'; return; }
    div.style.display='block';
    const inputHTML = `<input type="text" id="comment-input-${id}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"/>
                       <button onclick="addComment('${id}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>`;
    div.innerHTML = inputHTML;

    db.collection('posts').doc(id).get().then(doc=>{
        const post = doc.data();
        post.comments.forEach(c=>{
            const cdiv = document.createElement('div');
            cdiv.textContent=`${c.author}: ${c.text}`;
            div.appendChild(cdiv);
        });
    });
}

function addComment(id){
    if(!currentUser){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!'); return; }
    const input = document.getElementById(`comment-input-${id}`);
    const text = input.value.trim();
    if(!text) return;
    const comment = {author:'@'+currentUser.displayName, text};
    db.collection('posts').doc(id).update({
        comments: firebase.firestore.FieldValue.arrayUnion(comment)
    }).then(()=>{
        input.value='';
        showComments(id);
    });
}
</script>
</body>
</html>
