<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Echo</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<style>
body { background:#121212; color:#fff; font-family:sans-serif; margin:0; padding:0; }
header { padding:15px; background:#1a1a1a; text-align:center; font-size:1.5em; font-weight:bold; }
#auth-buttons { padding:10px; display:flex; gap:10px; justify-content:center; background:#1a1a1a; }
#nickname-modal {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.8); justify-content:center; align-items:center;
}
#nickname-modal > div { background:#222; padding:20px; border-radius:10px; text-align:center; }
.new-post { margin:10px; display:flex; gap:5px; justify-content:center; }
.new-post input { flex:1; padding:5px; }
.new-post button { padding:5px 10px; }
.post { background:#1e1e1e; margin:10px auto; padding:10px; border-radius:8px; width:90%; max-width:600px; }
.post button { margin-right:5px; }
</style>
</head>
<body>

<header>Echo</header>

<div id="auth-buttons">
    <button onclick="signIn()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <button onclick="signOut()">–í—ã–π—Ç–∏</button>
</div>

<div id="nickname-modal">
    <div>
        <h3>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫</h3>
        <input type="text" id="nickname-input" placeholder="–í–∞—à –Ω–∏–∫" style="padding:5px; margin-top:10px;"/>
        <button onclick="saveNickname()" style="margin-top:10px; padding:5px 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<div class="new-post">
    <input type="text" id="new-post-input" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?"/>
    <button onclick="addPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</div>

<div id="posts-tab"></div>

<script>
// --- Firebase config ---
const firebaseConfig = {
    apiKey: "AIzaSyDYNBFXBRNg68Z3u_T4JTa-kRqorWKtZek",
    authDomain: "echo-beta-edb51.firebaseapp.com",
    projectId: "echo-beta-edb51",
    storageBucket: "echo-beta-edb51.firebasestorage.app",
    messagingSenderId: "18552431523",
    appId: "1:18552431523:web:7541c2d8f549dcb55cf016",
    measurementId: "G-XQ49S7VDS1"
};
firebase.initializeApp(firebaseConfig);
let currentUser = null;
let postsData = [];

// --- Auth state ---
firebase.auth().onAuthStateChanged(user => {
    currentUser = user;
    if(user && !user.displayName){
        document.getElementById('nickname-modal').style.display='flex';
    }
    renderPosts();
});

// --- Sign in via redirect ---
function signIn(){
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithRedirect(provider);
}

// --- Handle redirect result ---
firebase.auth().getRedirectResult().then(result => {
    if(result.user){
        currentUser = result.user;
        if(!currentUser.displayName){
            document.getElementById('nickname-modal').style.display='flex';
        }
        renderPosts();
    }
}).catch(err => console.log(err));

// --- Sign out ---
function signOut(){
    firebase.auth().signOut().then(()=>{ currentUser=null; renderPosts(); });
}

// --- Save nickname ---
function saveNickname(){
    const nick = document.getElementById('nickname-input').value.trim();
    if(!nick) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!');
    currentUser.updateProfile({displayName:nick}).then(()=>{
        document.getElementById('nickname-modal').style.display='none';
        renderPosts();
    });
}

// --- Add post ---
function addPost(){
    if(!currentUser) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!');
    const text = document.getElementById('new-post-input').value.trim();
    if(!text) return;
    postsData.unshift({
        id: postsData.length+1,
        author: '@'+currentUser.displayName,
        text,
        likes:0,
        reposts:0,
        comments:[]
    });
    document.getElementById('new-post-input').value='';
    renderPosts();
}

// --- Render posts ---
function renderPosts(){
    const container = document.getElementById('posts-tab');
    container.innerHTML='';
    postsData.forEach(post=>{
        const div = document.createElement('div');
        div.className='post';
        div.innerHTML=`
            <h4>${post.author}</h4>
            <p>${post.text}</p>
            <button onclick="likePost(${post.id})">‚ù§ ${post.likes}</button>
            <button onclick="showComments(${post.id})">üí¨ ${post.comments.length}</button>
            <button onclick="repostPost(${post.id})">üîÅ ${post.reposts}</button>
            <div id="comments-${post.id}"></div>
        `;
        container.appendChild(div);
    });
}

// --- Like, repost, comment ---
function likePost(id){ 
    if(!currentUser){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!'); return; } 
    postsData.find(p=>p.id===id).likes++; 
    renderPosts(); 
}

function repostPost(id){ 
    if(!currentUser){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!'); return; } 
    postsData.find(p=>p.id===id).reposts++; 
    renderPosts(); 
}

function showComments(id){
    const post = postsData.find(p=>p.id===id);
    const div = document.getElementById(`comments-${id}`);
    if(div.style.display==='block'){ div.style.display='none'; return; }
    div.style.display='block';
    div.innerHTML=`<input type="text" id="comment-input-${id}" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"/><button onclick="addComment(${id})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>`;
    post.comments.forEach(c=>{
        const cdiv = document.createElement('div');
        cdiv.textContent=`${c.author}: ${c.text}`;
        div.appendChild(cdiv);
    });
}

function addComment(id){ 
    if(!currentUser){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!'); return; }
    const post = postsData.find(p=>p.id===id);
    const input = document.getElementById(`comment-input-${id}`);
    const text = input.value.trim();
    if(!text) return;
    post.comments.push({author:'@'+currentUser.displayName, text});
    input.value='';
    showComments(id);
}
</script>
</body>
</html>
